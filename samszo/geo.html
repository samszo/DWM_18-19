<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <title>Geolocalisation</title>

    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js" ></script>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry,places&ext=.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css">
</head>
<body>

<h1>Exemple de géolocalisation</h1>
<div id="txtGeo" ></div>
<div id="map_2385853" style="width:100%;height:500px; z-index:1;"></div>

<script>
var map, geoPosi, optionsGeo = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  };
  
  function successGeo(pos) {
    geoPosi = pos;
    let html = 'Votre position actuelle est :<br/>'
      +'Latitude : '+geoPosi.coords.latitude+'<br/>'
      +'Longitude : '+geoPosi.coords.longitude+'<br/>'
      +'La précision est de '+geoPosi.coords.accuracy+' mètres.';

    document.getElementById('txtGeo').innerHTML=html;
    geoPosi.latlng = {
      lat: geoPosi.coords.latitude,
      lng: geoPosi.coords.longitude      
    };
    geoPosi.accuracy = geoPosi.coords.accuracy;
    onLocationFound(geoPosi);

    /*
    console.log('Votre position actuelle est :');    
    console.log(`Latitude : ${geoPosi.coords.latitude}`);
    console.log(`Longitude : ${geoPosi.coords.longitude}`);
    console.log(`La précision est de ${geoPosi.coords.accuracy} mètres.`);
    */
  }
  
  function errorGeo(err) {
    console.warn(`ERREUR (${err.code}): ${err.message}`);
    geoPosi=false;
  }
  
function getGeoInfos(){
    if(geoPosi)
        return {'lat':geoPosi.coords.latitude,'lng':geoPosi.coords.longitude,'pre':geoPosi.coords.accuracy,'t':geoPosi.timestamp};
    else
        return {};
}

/*
merci à https://stackoverflow.com/questions/40433317/leaflet-map-update-marker-using-navigator-geolocation-watchposition
*/
function initializeMapAndLocator(){

  map = L.map('map_2385853');

  /*fond de carte google
  var googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
      maxZoom: 20,
      subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);
  */
  // fond de carte OSM
  var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    osmAttrib='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
    osm = L.tileLayer(osmUrl, {minZoom: 1, maxZoom: 16, attribution: osmAttrib})
      .addTo(map);
  
  map.locate({setView: true, 
        maxZoom: 16, 
        watch:true, 
        timeout: 60000
        });
    
  map.on('locationfound', onLocationFound);
  
}

function onLocationFound(e) {
      var radius = e.accuracy / 2;
      L.marker(e.latlng).addTo(map)
        .bindPopup("Vous êtes environ à " + radius + " mètres de ce point").openPopup();
      L.circle(e.latlng, radius).addTo(map);
  }

initializeMapAndLocator();
navigator.geolocation.getCurrentPosition(successGeo, errorGeo, optionsGeo);

</script>
</body>
</html>